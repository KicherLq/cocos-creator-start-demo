{"version":3,"sources":["file:///C:/Users/ctwl/Downloads/cocos-nodejs-io-game-start-demo-master/apps/client/assets/Scripts/Scene/BattleManager.ts"],"names":["_decorator","Component","Prefab","instantiate","SpriteFrame","DataManager","JoyStickManager","ActorManager","ResourceManager","PrefabPathEnum","TexturePathEnum","EntityTypeEnum","InputTypeEnum","BulletManager","ObjectPoolManager","NetWorkManager","ccclass","property","BattleManager","_stage","_ui","shouldUpdate","onLoad","node","getChildByName","destroyAllChildren","Instance","jm","getComponentInChildren","stage","start","connectServer","sendMessage","e","connect","catch","Promise","rs","setTimeout","initMap","prefab","prefabMap","get","Map","map","setParent","loadRes","list","p","type","then","set","push","loadDir","spriteframes","textureMap","all","update","dt","render","tick","tickActor","applyInput","TimePast","data","state","actors","id","am","actorMap","renderActor","renderBullet","actor","addComponent","init","bullets","bm","bulletMap","bullet","getComponent"],"mappings":"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","sourcesContent":["import { Node } from \"cc\";\r\nimport { _decorator, Component } from \"cc\";\r\nimport DataManager from \"../Global/DataManager\";\r\nimport { JoyStickManager } from \"../UI/JoyStickManager\";\r\nimport { ActorManager } from \"../Entity/Actor/ActorManager\";\r\nimport { ResourceManager } from \"../Global/ResourceManager\";\r\nimport { Prefab } from \"cc\";\r\nimport { instantiate } from \"cc\";\r\nimport { PrefabPathEnum, TexturePathEnum } from \"../Enum\";\r\nimport { EntityTypeEnum, InputTypeEnum } from \"../Common/Enum\";\r\nimport { SpriteFrame } from \"cc\";\r\nimport { BulletManager } from \"../Entity/Bullet/BulletManager\";\r\nimport { ObjectPoolManager } from \"../Global/ObjectPoolManager\";\r\nimport { NetWorkManager } from \"../Global/NetWorkManager\";\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('BattleManager')\r\nexport class BattleManager extends Component {\r\n    private _stage: Node;\r\n    private _ui: Node;\r\n    private shouldUpdate: boolean = false;\r\n\r\n    onLoad() {\r\n        this._stage = this.node.getChildByName('Stage');\r\n        this._ui    = this.node.getChildByName('UI');\r\n        this._stage.destroyAllChildren();\r\n        DataManager.Instance.jm = this._ui.getComponentInChildren(JoyStickManager);\r\n        DataManager.Instance.stage = this.node.getChildByName('Stage');\r\n    }\r\n    \r\n    async start() {\r\n        // await this.loadRes();\r\n        // this.initMap();\r\n        // this.shouldUpdate = true;\r\n        await this.connectServer();\r\n        NetWorkManager.Instance.sendMessage('hello, here is client.');\r\n    }\r\n\r\n    async connectServer() {\r\n        const e = await NetWorkManager.Instance.connect().catch(() => false);\r\n        if(e !== false) {\r\n            await new Promise(rs => setTimeout(rs, 1000));\r\n            await this.connectServer();\r\n        }\r\n    }\r\n\r\n    initMap() {\r\n        const prefab = DataManager.Instance.prefabMap.get(EntityTypeEnum.Map);\r\n        const map = instantiate(prefab);\r\n        map.setParent(this._stage);\r\n    }\r\n\r\n    async loadRes() {\r\n        const list = [];\r\n        for (const type in PrefabPathEnum) {\r\n            const p = ResourceManager.Instance.loadRes(PrefabPathEnum[type], Prefab).then(prefab => {\r\n                DataManager.Instance.prefabMap.set(type, prefab);\r\n            });\r\n            list.push(p);\r\n        }\r\n\r\n        for (const type in TexturePathEnum) {\r\n            const p = ResourceManager.Instance.loadDir(TexturePathEnum[type], SpriteFrame).then(spriteframes => {\r\n                DataManager.Instance.textureMap.set(type, spriteframes);\r\n            });\r\n            list.push(p);\r\n        }\r\n        \r\n        const p = await Promise.all(list);\r\n    }\r\n    \r\n    update(dt: number) {\r\n        if(!this.shouldUpdate) {\r\n            return;\r\n        }\r\n        this.render();\r\n        this.tick(dt);\r\n    }\r\n\r\n    tick(dt: number) {\r\n        this.tickActor(dt);\r\n\r\n        DataManager.Instance.applyInput({\r\n            type: InputTypeEnum.TimePast,\r\n            dt\r\n        });\r\n    }\r\n    tickActor(dt: number) {\r\n        for (const data of DataManager.Instance.state.actors) {\r\n            const {id} = data;\r\n            let am: ActorManager = DataManager.Instance.actorMap.get(id);\r\n            am.tick(dt);\r\n        }\r\n    }\r\n\r\n    render() {\r\n        this.renderActor();\r\n        this.renderBullet();\r\n    }\r\n\r\n    renderActor() {\r\n        for(const data of DataManager.Instance.state.actors) {\r\n            const {id, type} = data;\r\n            let am: ActorManager = DataManager.Instance.actorMap.get(id);\r\n            if(!am) {\r\n                const prefab = DataManager.Instance.prefabMap.get(type);\r\n                const actor  = instantiate(prefab);\r\n                actor.setParent(this._stage);\r\n                let am: ActorManager = actor.addComponent(ActorManager);\r\n                DataManager.Instance.actorMap.set(data.id, am);\r\n                am.init(data);\r\n            } else {\r\n                am.render(data);\r\n            }\r\n        }\r\n    }\r\n\r\n    renderBullet() {\r\n        for(const data of DataManager.Instance.state.bullets) {\r\n            const {id, type} = data;\r\n            let bm = DataManager.Instance.bulletMap.get(id);\r\n            if(!bm) {\r\n                const bullet = ObjectPoolManager.Instance.get(type);\r\n                bm = bullet.getComponent(BulletManager) || bullet.addComponent(BulletManager);\r\n                DataManager.Instance.bulletMap.set(data.id, bm);\r\n                bm.init(data);\r\n            } else {\r\n                bm.render(data);\r\n            }\r\n        }\r\n    }\r\n}"]}