{"version":3,"sources":["file:///C:/Users/ctwl/Downloads/cocos-nodejs-io-game-start-demo-master/apps/client/assets/Scripts/Entity/Weapon/WeaponManager.ts"],"names":["_decorator","UITransform","Vec2","DataManager","InputTypeEnum","EntityManager","EntityStateEnum","EventEnum","WeaponStateMachine","EventManager","ccclass","property","WeaponManager","__body","__anchor","__point","__owner","init","data","id","node","getChildByName","fsm","addComponent","weaponType","state","Idle","Instance","on","bulletBorn","handleBulletBorn","shot","handleWeaponShot","onDestroy","off","owner","Attack","myPlayerId","pointWorldPos","getWorldPosition","pointStagePos","stage","getComponent","convertToNodeSpaceAR","anchorWorldPos","direction","x","y","normalize","applyInput","type","Shot","position","console","log","bullets"],"mappings":"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","sourcesContent":["import { _decorator, Component, input } from 'cc';\r\nimport DataManager from \"../../Global/DataManager\";\r\nimport { EntityTypeEnum, InputTypeEnum } from '../../Common/Enum';\r\nimport { IActor } from '../../Common/State';\r\nimport { EntityManager } from '../../Base/EntityManager';\r\nimport { EntityStateEnum, EventEnum } from '../../Enum';\r\nimport { instantiate } from 'cc';\r\nimport { WeaponStateMachine } from './WeaponStateMachine';\r\nimport { Node } from 'cc';\r\nimport EventManager from '../../Global/EventManager';\r\nimport { UITransform } from 'cc';\r\nimport { Vec2 } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('WeaponManager')\r\nexport class WeaponManager extends EntityManager {\r\n    private __body: Node = null;\r\n    private __anchor: Node = null;\r\n    private __point: Node = null;\r\n    private __owner: number = 0;\r\n\r\n    init(data: IActor) {\r\n        this.__owner = data.id;\r\n        this.__body = this.node.getChildByName('Body');\r\n        this.__anchor = this.__body.getChildByName('Anchor');\r\n        this.__point = this.__anchor.getChildByName('Point');\r\n        \r\n        this.fsm = this.__body.addComponent(WeaponStateMachine);\r\n        this.fsm.init(data.weaponType);\r\n\r\n        this.state = EntityStateEnum.Idle;\r\n        EventManager.Instance.on(EventEnum.bulletBorn, this.handleBulletBorn, this);\r\n        EventManager.Instance.on(EventEnum.shot, this.handleWeaponShot, this);\r\n    }\r\n\r\n    protected onDestroy(): void {\r\n        EventManager.Instance.off(EventEnum.bulletBorn, this.handleBulletBorn, this);\r\n        EventManager.Instance.off(EventEnum.shot, this.handleWeaponShot, this);\r\n    }\r\n\r\n    handleBulletBorn(owner: number) {\r\n        if(owner !== this.__owner) {\r\n            return;\r\n        }\r\n\r\n        this.state = EntityStateEnum.Attack;\r\n    }\r\n\r\n    handleWeaponShot() {\r\n        if(this.__owner !== DataManager.Instance.myPlayerId) {\r\n            return;\r\n        }\r\n        \r\n        const pointWorldPos = this.__point.getWorldPosition();\r\n        const pointStagePos = DataManager.Instance.stage.getComponent(UITransform).convertToNodeSpaceAR(pointWorldPos);\r\n        const anchorWorldPos = this.__anchor.getWorldPosition();\r\n        const direction = new Vec2(pointWorldPos.x - anchorWorldPos.x, pointWorldPos.y - anchorWorldPos.y).normalize();\r\n\r\n        DataManager.Instance.applyInput({\r\n            type: InputTypeEnum.Shot,\r\n            owner: this.__owner,\r\n            position: {\r\n                x: pointStagePos.x, \r\n                y: pointStagePos.y\r\n            },\r\n            direction: {\r\n                x: direction.x,\r\n                y: direction.y\r\n            },\r\n        });\r\n\r\n        console.log(DataManager.Instance.state.bullets);\r\n    }\r\n    \r\n}"]}