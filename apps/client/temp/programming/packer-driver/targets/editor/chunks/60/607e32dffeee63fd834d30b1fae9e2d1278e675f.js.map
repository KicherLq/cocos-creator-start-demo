{"version":3,"sources":["file:///C:/Users/ctwl/Downloads/cocos-nodejs-io-game-start-demo-master/apps/client/assets/Scripts/Scene/BattleManager.ts"],"names":["_decorator","Component","Prefab","instantiate","DataManager","JoyStickManager","ActorManager","ResourceManager","PrefabPathEnum","EntityTypeEnum","ccclass","property","BattleManager","_stage","_ui","shouldUpdate","onLoad","node","getChildByName","destroyAllChildren","Instance","jm","getComponentInChildren","start","loadRes","initMap","prefab","prefabMap","get","Map","map","setParent","list","type","p","then","set","push","Promise","all","console","log","update","render","renderActor","data","state","actors","id","am","actorMap","actor","addComponent","init"],"mappings":"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","sourcesContent":["import { Node } from \"cc\";\r\nimport { _decorator, Component } from \"cc\";\r\nimport DataManager from \"../Global/DataManager\";\r\nimport { JoyStickManager } from \"../UI/JoyStickManager\";\r\nimport { ActorManager } from \"../Entity/Actor/ActorManager\";\r\nimport { ResourceManager } from \"../Global/ResourceManager\";\r\nimport { Prefab } from \"cc\";\r\nimport { instantiate } from \"cc\";\r\nimport { PrefabPathEnum } from \"../Enum\";\r\nimport { EntityTypeEnum } from \"../Common/Enum\";\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('BattleManager')\r\nexport class BattleManager extends Component {\r\n    private _stage: Node;\r\n    private _ui: Node;\r\n    private shouldUpdate: boolean = false;\r\n\r\n    onLoad() {\r\n        this._stage = this.node.getChildByName('Stage');\r\n        this._ui    = this.node.getChildByName('UI');\r\n        this._stage.destroyAllChildren();\r\n        DataManager.Instance.jm = this._ui.getComponentInChildren(JoyStickManager);\r\n    }\r\n    \r\n    async start() {\r\n        await this.loadRes();\r\n        this.initMap();\r\n        this.shouldUpdate = true;\r\n    }\r\n\r\n    initMap() {\r\n        const prefab = DataManager.Instance.prefabMap.get(EntityTypeEnum.Map);\r\n        const map = instantiate(prefab);\r\n        map.setParent(this._stage);\r\n    }\r\n\r\n    async loadRes() {\r\n        const list = [];\r\n        for (const type in PrefabPathEnum) {\r\n            const p = ResourceManager.Instance.loadRes(PrefabPathEnum[type], Prefab).then(prefab => {\r\n                DataManager.Instance.prefabMap.set(type, prefab);\r\n            });\r\n            list.push(p);\r\n        }\r\n        \r\n        const p = await Promise.all(list);\r\n        console.log(p);\r\n    }\r\n    update() {\r\n        if(!this.shouldUpdate) {\r\n            return;\r\n        }\r\n        this.render();\r\n    }\r\n\r\n    render() {\r\n        this.renderActor();\r\n    }\r\n\r\n    renderActor() {\r\n        for(const data of DataManager.Instance.state.actors) {\r\n            const {id, type} = data;\r\n            let am: ActorManager = DataManager.Instance.actorMap.get(id);\r\n            if(!am) {\r\n                const prefab = DataManager.Instance.prefabMap.get(type);\r\n                const actor  = instantiate(prefab);\r\n                actor.setParent(this._stage);\r\n                let am: ActorManager = actor.addComponent(ActorManager);\r\n                DataManager.Instance.actorMap.set(data.id, am);\r\n                am.init(data);\r\n            } else {\r\n                am.render(data);\r\n            }\r\n        }\r\n    }\r\n}"]}